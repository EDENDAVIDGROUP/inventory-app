<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>יבוא הזמנות</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f4f4f4;
      direction: rtl;
    }

    h1 {
      color: #333;
    }

    .upload-section {
      margin-top: 30px;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 800px;
    }

    input[type="file"], select {
      display: block;
      margin-bottom: 20px;
      width: 100%;
      padding: 8px;
    }

    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #2980b9;
    }

    #mappingSection {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h1>יבוא הזמנות מקובץ</h1>

  <div class="upload-section">
    <label for="excelFile">בחר קובץ Excel עם הזמנות:</label>
    <input type="file" id="excelFile" accept=".xlsx, .xls">
    <div id="mappingSection"></div>
    <button onclick="uploadFile()">ייבוא הזמנות</button>
  </div>

  <script>
    let headerRow = [];
    let sheetData = [];
    let selectedClient = "";

    function createMappingUI(headers) {
      const mappingFields = ['id', 'name', 'phone', 'city', 'platform', 'quantity', 'product', 'status', 'shipping'];
      const labels = {
        id: 'מספר הזמנה', name: 'שם לקוח', phone: 'טלפון', city: 'עיר', platform: 'פלטפורמה',
        quantity: 'כמות', product: 'מוצר', status: 'סטטוס', shipping: 'שיטת שילוח'
      };

      let html = '<h3>מיפוי עמודות</h3>';
      html += '<label>בחר לקוח:</label><select id="clientSelector"><option value="">בחר לקוח</option>';
      const clients = ['שלך לגמלאי', 'טוב פלוס', 'פייס', 'לאומי בונוס', 'ויזה', 'BOXMASTER', 'PRO-TOOLS'];
      clients.forEach(c => html += `<option value="${c}">${c}</option>`);
      html += '</select>';

      mappingFields.forEach(field => {
        html += `<label>${labels[field]}:</label><select id="map_${field}">`;
        html += '<option value="">בחר עמודה</option>';
        headers.forEach(h => {
          html += `<option value="${h}">${h}</option>`;
        });
        html += '</select>';
      });
      document.getElementById('mappingSection').innerHTML = html;
    }

    function uploadFile() {
      const fileInput = document.getElementById('excelFile');
      if (!fileInput.files.length) {
        alert("נא לבחור קובץ לפני הייבוא.");
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        if (json.length === 0) {
          alert("הקובץ ריק או בפורמט לא תקין.");
          return;
        }

        headerRow = Object.keys(json[0]);
        sheetData = json;
        createMappingUI(headerRow);
        alert("נא להשלים את מיפוי העמודות ואז ללחוץ שוב על ייבוא הזמנות.");
      };

      reader.readAsArrayBuffer(file);
    }

    function sendMappedOrders() {
      const client = document.getElementById('clientSelector')?.value;
      if (!client) {
        alert("נא לבחור את הלקוח לפני השליחה.");
        return;
      }
      const fields = ['id', 'name', 'phone', 'city', 'platform', 'quantity', 'product', 'status', 'shipping'];

      const mapping = {};
      fields.forEach(field => {
        mapping[field] = document.getElementById('map_' + field)?.value || "";
      });

      localStorage.setItem(`mapping_${client}`, JSON.stringify(mapping));

      const mapped = sheetData.map(row => {
        let obj = {};
        fields.forEach(field => {
          obj[field] = mapping[field] ? row[mapping[field]] || '' : '';
        });
        obj.date = new Date().toLocaleDateString('he-IL');
        return obj;
      });

      localStorage.setItem('importedOrders', JSON.stringify(mapped));
      alert("ההזמנות מוּפו בהצלחה ונשלחו לקטגוריית הזמנות חדשות!");
    }

    document.querySelector('button').addEventListener('click', function() {
      if (sheetData.length && document.getElementById('map_id')) {
        sendMappedOrders();
      }
    });
  </script>
</body>
</html>
